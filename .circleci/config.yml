version: 2.1
orbs:
  aws-cli: circleci/aws-cli@0.1.13
jobs:
  build:
    docker:
      - image: circleci/node:8.10
    working_directory: ~/repo
    parameters:
      profile-name:
        description: Profile name to be configured.
        type: string
        default: default
      aws-access-key-id:
        description: |
          AWS access key id for IAM role. Set this to the name of
          the environment variable you will use to hold this
          value, i.e. AWS_ACCESS_KEY.
        type: env_var_name
        default: AWS_ACCESS_KEY_ID
      aws-secret-access-key:
        description: |
          AWS secret key for IAM role. Set this to the name of
          the environment variable you will use to hold this
          value, i.e. $AWS_SECRET_ACCESS_KEY.
        type: env_var_name
        default: AWS_SECRET_ACCESS_KEY
      aws-region:
        description: |
          Env var of AWS region to operate in
          (defaults to AWS_DEFAULT_REGION)
        type: env_var_name
        default: AWS_DEFAULT_REGION
      configure-default-region:
        description: >
          Some AWS actions don't require a region; set this to false if you do not
          want to store a default region in ~/.aws/config
        type: boolean
        default: true
    steps:
      - checkout
      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run:
          name: Configure AWS Access Key ID
          command: |
            aws configure set aws_access_key_id \
            $<<parameters.aws-access-key-id>> \
            --profile <<parameters.profile-name>>
      - run:
          name: Configure AWS Secret Access Key
          command: |
            aws configure set aws_secret_access_key \
            $<<parameters.aws-secret-access-key>> \
            --profile <<parameters.profile-name>>
      - when:
          condition: <<parameters.configure-default-region>>
          steps:
            - run:
                name: Configure AWS default region
                command: |
                  aws configure set region $<<parameters.aws-region>> \
                  --profile <<parameters.profile-name>>
      - run:
          name: Install dependencies
          command: npm install
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - run:
          name: Deploy application to sit
          command: npm run deploy:sit
      - run:
          name: Recreate database
          command: node seedMasters.js masters-sit
      - run:
          name: Run integration tests
          command: TEST_STAGE=sit npm run test:integration
      - run:
          name: Run acceptance tests
          command: npm run test:acceptance
      - run:
          name: Deploy application
          command: npm run deploy:prod